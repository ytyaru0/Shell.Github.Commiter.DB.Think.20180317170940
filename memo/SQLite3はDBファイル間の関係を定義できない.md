# SQLite3はDBファイル間の関係を定義できない

## 問題

SQLite3を使うとき、DBファイル間の依存関係を定義する方法がない。

## 原因

ファイル上限。OSのファイルシステム次第で2GB,4GBのように上限がある。

http://q.hatena.ne.jp/1341044027

## 解決

SQLiteをやめてMySQLなど別のRDBMSを使う。

## 困ること

DB作成を自動化できない。

* 包含関係 contain
    * 親から先に作成すべきなのに
        * 作成する順序が特定できない
            * ハードコーディングすると汎用性のないコードになってしまう
* 前後関係 list
    * ファイルサイズ肥大化に伴い別ファイル化したくなる（OSにより1ファイル4GBまで）
        * ファイル名を変えて管理せねばならない
            * 同一DBとして認識できない
            * 順序関係が不明

### contain

異なるColumnを持ったTableを部分として持たせたいことがある。一般的には、外部キー制約`foreign key`により実現する。

だが、SQLite3はファイル間における外部キー制約を定義できない。

### list

SQLite3は1ファイルを1DBとしている。だがOSのファイルシステムにより、1ファイル4GBまでのような制限がある。

データはそれ以上持たせたい。DBをファイル分割する案を思いつく。

だが、別ファイル間を取り次ぐ仕組みがない。

## 関係

関係は複数ある。

relationsip|説明
-----------|----
contain|包含。集合。部分。親子。
list|順序。

### contain

* Users.db
* Users/
    * {User.Id}.Repo.db

特定のUserごとにRepo.dbを持っている。

以下のようなメリットがある。

* 重複データを減らせる
* 最初からselect状態になる
* 操作ファイルの分散
    * list化回数の減少

以下のようなデメリットがある。

* ユーザごとに必要
    * 別ファイル名
    * `db.connect()`

内部でDBアクセサをつくり、簡単にアクセスできるようにする必要がある。

### list

* Repo_0.db
* Repo_1.db
* ...
* Repo_9.db
* Repo_10.db

ファイルサイズ肥大化により分割せざるを得なくなる。

だが、以下のSQL文を発行したら、すべてのDBファイルを対象としてほしい。

```sh
select * from Repositories;
```

内部で全ファイルに対して発行する必要がある。

致命的な問題として、Idだけで特定できなくなる。

#### ID

同一Tableのデータを複数ファイルに分割すると、Idが一意でなくなってしまう。

A. 複数DBファイル間で共通するIdを作り管理する
B. Idは持たせずNameなど事実上Uniqueな値で操作する
C. Idとファイル名を合わせて識別子とする

C案がベターか。実装せねばならない。

#### 全ファイル対象

Insert,Delete,Update,の場合、以下のような違いがある。

DDL|対象
---|----
Select|全ファイル 
Insert|最新ファイル。ファイルサイズ一定値超過なら新規DBファイル作成しそちらへ。
Delete|全ファイルからSelectし対象ファイルを探す
Update|全ファイルからSelectし対象ファイルを探す

##### データ詰め

DBファイル間のデータ詰めが難しい。たとえば `Repo_3.db` 内のデータをほとんど削除したとき。`Repo_4.db` のデータを移行して、データを詰めていきたい。だが、あまりに量が多すぎる。やる価値はあるのか？ HDDの劣化をさせてまで？

データ詰めをしなかった場合、小DBを開いて閉じるタイムラグが大きくなる。データ詰めの負荷とくらべたら微々たるものか。

Insertするとき、空いている古いDBに挿入すればいいかもしれない。だが、Sortが大変なことになる。膨大なデータ内から毎回Sortする無駄は省きたい。Date列のMin(), Max()をすればそのDB内でDate順に詰められていることを保証したい。

結局、Deleteしてサイズ減してもそのままにするのがベターか。Deleteはあまり想定していない。

